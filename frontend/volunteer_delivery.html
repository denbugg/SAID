<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ü—Ä–∏—ë–º –æ—Ç–≥—Ä—É–∑–∫–∏ –Ω–∞ –ø—É–Ω–∫—Ç–µ –≤—ã–¥–∞—á–∏ ‚Äî SAID-DONE</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <h2>üì¶ –ü—Ä–∏—ë–º –æ—Ç–≥—Ä—É–∑–∫–∏ –Ω–∞ –ø—É–Ω–∫—Ç–µ –≤—ã–¥–∞—á–∏</h2>

        <div id="delivery-info">
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ -->
        </div>

        <div id="confirm-section" style="margin-top:20px;">
            <h4>üìÑ –í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ —Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –Ω–∞–∫–ª–∞–¥–Ω–æ–π:</h4>
            <input type="text" id="qrInput" placeholder="–í–≤–µ–¥–∏—Ç–µ QR-–∫–æ–¥">
            <button onclick="confirmDelivery()">‚úÖ –ü—Ä–∏–Ω—è—Ç—å –æ—Ç–≥—Ä—É–∑–∫—É</button>
        </div>
    </div>

    <script>
        async function loadDelivery() {
            const deliveryId = localStorage.getItem("selected_delivery_id");

            if (!deliveryId) {
                document.getElementById('delivery-info').innerHTML = "<p>–û—à–∏–±–∫–∞: –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞.</p>";
                return;
            }

            try {
                const response = await fetch(`/api/volunteer/delivery/${deliveryId}`);
                if (!response.ok) {
                    throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏");
                }
                const delivery = await response.json();
                renderDelivery(delivery);
            } catch (error) {
                console.error(error);
                document.getElementById('delivery-info').innerText = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.";
            }
        }

        function renderDelivery(delivery) {
            const div = document.getElementById('delivery-info');
            div.innerHTML = `
                <h3>–ù–æ–º–µ—Ä –¥–æ—Å—Ç–∞–≤–∫–∏: ${delivery.id}</h3>
                <p>–°–ø–∏—Å–æ–∫ –ø–æ–∑–∏—Ü–∏–π:<br>${delivery.items.map(item => `${item.name} ‚Äî ${item.quantity} —à—Ç.`).join("<br>")}</p>
            `;
        }

        async function confirmDelivery() {
            const deliveryId = localStorage.getItem("selected_delivery_id");
            const qrCode = document.getElementById("qrInput").value.trim();

            if (!qrCode) {
                alert("–í–≤–µ–¥–∏—Ç–µ QR-–∫–æ–¥ –Ω–∞–∫–ª–∞–¥–Ω–æ–π!");
                return;
            }

            try {
                const response = await fetch(`/api/volunteer/confirm`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ delivery_id: deliveryId, qr_code: qrCode })
                });

                if (response.ok) {
                    alert("–î–æ—Å—Ç–∞–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–Ω—è—Ç–∞!");
                    window.location.href = "/frontend/volunteer_delivery.html";
                } else {
                    alert("–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏.");
                }
            } catch (error) {
                console.error(error);
                alert("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.");
            }
        }

        loadDelivery();
    </script>
</body>
</html>
